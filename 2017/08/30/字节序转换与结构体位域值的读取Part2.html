<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>字节序转换与结构体位域值(bit field)的读取Part2-深入理解字节序和结构体位域存储方式 – /* Coding - 午夜场 */</title> <meta name="description" content="一个想用技术改变世界却被世界用魔术改变的人的一些事情"> <meta name="keywords" content=""> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://www.sujing.info/assets/img/logo.png"> <meta name="twitter:title" content="字节序转换与结构体位域值(bit field)的读取Part2-深入理解字节序和结构体位域存储方式"> <meta name="twitter:description" content="上一篇文章讲解了带位域的结构体，在从大端机（Big Endian）传输到小端机(Little Endian)后如何解析位域值。下面继续深入详解字节序，以及位域存储的方式。"> <meta name="twitter:site" content="@solarwindsj"> <meta name="twitter:creator" content="@solarwindsj"> <!-- Open Graph --> <meta property="og:locale" content="zh_CN"> <meta property="og:type" content="article"> <meta property="og:title" content="字节序转换与结构体位域值(bit field)的读取Part2-深入理解字节序和结构体位域存储方式"> <meta property="og:description" content="上一篇文章讲解了带位域的结构体，在从大端机（Big Endian）传输到小端机(Little Endian)后如何解析位域值。下面继续深入详解字节序，以及位域存储的方式。"> <meta property="og:url" content="http://www.sujing.info/2017/08/30/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F%E5%80%BC%E7%9A%84%E8%AF%BB%E5%8F%96Part2.html"> <meta property="og:site_name" content="/* Coding - 午夜场 */"> <meta property="og:image" content="http://www.sujing.info/assets/img/logo.png"> <link rel="canonical" href="http://www.sujing.info/2017/08/30/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F%E5%80%BC%E7%9A%84%E8%AF%BB%E5%8F%96Part2.html"> <link href="http://www.sujing.info/feed.xml" type="application/atom+xml" rel="alternate" title="/* Coding - 午夜场 */ Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://www.sujing.info/assets/css/main.css"> <!-- JS --> <script src="http://www.sujing.info/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://www.sujing.info/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://www.sujing.info/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://www.sujing.info/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://www.sujing.info/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://www.sujing.info/favicon.png"> <link rel="shortcut icon" href="http://www.sujing.info/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://www.sujing.info/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://www.sujing.info/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://www.sujing.info/assets/img/logo.png" alt="/* Coding - 午夜场 */ photo" class="author-photo"> <h4>/* Coding - 午夜场 */</h4> <p>一个想用技术改变世界却被世界用魔术改变的人的一些事情</p> </li> <li><a href="http://www.sujing.info/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/solarwindsj" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://instagram.com/radiolover1983" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-instagram"></i> Instagram</a> </li> <li> <a href="http://github.com/radiolover" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://www.sujing.info/posts/">All Posts</a></li> <li><a href="http://www.sujing.info/tags/">All Tags</a></li> </ul> </li> <li><a href="http://www.sujing.info/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>字节序转换与结构体位域值(bit field)的读取Part2-深入理解字节序和结构体位域存储方式</h1> <h4>30 Aug 2017</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~1 minute </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://www.sujing.info/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>上一篇文章讲解了带位域的结构体，在从大端机（Big Endian）传输到小端机(Little Endian)后如何解析位域值。下面继续深入详解字节序，以及位域存储的方式。</p> <p>(1) 我们知道，存储数字时，对小端机而言，数字的低位，存在低地址，高位存在高地址。大端机正相反。</p> <p>(2) 读取的方式，也是一样的。对于小端机，读出的低地址位作为数字的低位。</p> <p>(3) 此外Big-Endian/Little-Endian存储顺序，不仅仅针对字节，还针对字节内的比特位。对于小端机而言，字节内的8个比特，低地址端比特位，对应二进制数字的低位。</p> <p>(4) 对于结构体的多个位域，和普通成员一样，编译器同样按照地址由低到高顺序存储，无论是大端机还是小端机。只是位域内的比特顺序有区别罢了。</p> <p>(5) 表述一个数值，可以使用两种视图 :</p> <p>第一个是“逻辑视图”，通俗的表述方式，也就是我们平时在书本上看到的，手写数字时的方式。左边为高位，右边为低位。例如 375，-4.1，036，0xAF4D215B</p> <p>另一个是“内存视图”，即数字在内存中的存储方式，是我们程序员专有的一种表述方式。左边为低地址字节，右边为高地址字节。字节内左边为低地址比特位，右边为高地址比特位。很明显，同一个unsigned int值,在大端机、小端机上，分别有两种不同的“内存视图”。</p> <p>例如，uint16 0x2A1F，二进制比特位为0010 1010 0001 1111 （显然这一行使用的就是“逻辑视图”）</p> <p>在小端机上的“内存视图”为：1111 1000 0101 0100 （低地址 -&gt; 高地址）</p> <p>在大端机上的“内存视图”为：0010 1010 0001 1111 （低地址 -&gt; 高地址）</p> <p>另外可以看到，大端机的”内存视图”和”逻辑视图”是相同的。在很多相关的文章里，并没有去区分数字的两种表述方式，导致了很多混淆。其次，很多例子使用16进制，只能用于表达字节序，无法精确表达内部的比特顺序。</p> <p>再举一个上一节使用过的例子：</p> <figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_exam_</span>
<span class="p">{</span>
<span class="err">　　</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
<span class="err">　　</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="err">　　</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field2</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
<span class="err">　　</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field3</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span>
<span class="err">　　</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span><span class="n">Exam</span><span class="p">;</span>
 
<span class="n">Exam</span> <span class="n">ex</span><span class="p">;</span>
<span class="n">ex</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="n">ex</span><span class="p">.</span><span class="n">field1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">ex</span><span class="p">.</span><span class="n">field2</span> <span class="o">=</span> <span class="mh">0x3a</span><span class="p">;</span>
<span class="n">ex</span><span class="p">.</span><span class="n">field3</span> <span class="o">=</span> <span class="mh">0x4C1</span><span class="p">;</span>
<span class="n">ex</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></code></pre></figure> <p>变量ex的6个位域的”内存视图”，在大端机是000100 010 0111010 10010110001 00000（低地址-&gt;高地址），在小端机是001000 010 0101110 10001101001 00000（低地址-&gt;高地址）。可见位域顺序是一样的，但是位域内比特位顺序不同。</p> <p>若按照4位一组，大端机”内存视图”为 0001 0001 0011 1010 1001 0110 0010 0000，如果按照unsigned int的方式读取这块内存，结果是0x113A9620，四个比特位对应一个16进制数，和”逻辑视图”完全一样</p> <p>在小端机上4位一组排列，”内存视图”为 0010 0001 0010 1110 1000 1101 0010 0000，如果按照unsigned int的方式读取这块内存，就会按照小端机的方式来解析内存。可以先把二进制翻译为”逻辑视图” - 把整个”内存视图”32位颠倒顺序，结果是0x04B17484，注意不是0x212E8D20.</p> <p>那么这些规则，对位域值的读取有什么影响呢？</p> <p>字节流在网络上传输是按照网络字节序传输的，也就是大端序。网卡不知道数据的含义(到底是int还是double,还是什么image)，只能看到一个个字节，因此它做的就是把每个字节的8个比特位转换为本机的位序。而具体的内容，则由我们的程序处理。比如对于整形等，调用socket接口的ntohl(),htonl()…等函数转换字节序。顺便提一句，对于float/double类型，可以直接memcpy到一个整形里面，之后按照整形正常的处理流程，到了目标机后，再memcpy到一个float/double里。</p> <p>char,short,int,long等2次幂大小的整形，作为一个单独的整体，经过整个流程梳理是没有任何问题的。但无法保证结构体内的多个位域，按照定义的先后顺序，从低地址到高地址排列。这意味着，无论如何，直接在代码中使用ex.tag的方式，是读不出tag位域的数据的。</p> <p>细分有如下几种情况： (1) 主机内部传输无任何影响，毕竟是一样的CPU架构。</p> <p>(2) 相同字节序的主机间传输，同样没有影响。因为经过二次socket+网卡转换后，码流是相同的。读者可自行验证。</p> <p>(3) 大端机传输到小端机（上一节所描述的）。下列二进制值如没有特殊说明，都是”内存视图”。</p> <p>还以上面的位域为例，在大端机的为000100 010 0111010 10010110001 00000（低地址-&gt;高地址），按照四比特一组为： 0001 0001 0011 1010 1001 0110 0010 0000</p> <p>传输到网络中，由于大端序和网络序相同，所以网卡不做转换，字节流按照先后，依然是 0001 0001 0011 1010 1001 0110 0010 0000</p> <p>传输到小端机，网卡自动转换每个字节的比特序，但字节顺序维持原状， 1000 1000 0101 1100 0110 1001 0000 0100，可见原先跨字节相连的位域被”打散了”。字节内的位域，虽然比特顺序对了，但是从低比特位挪到了高比特位，位置错了。</p> <p>调用ntohl,比特序不变，转换字节序，0000 0100 0110 1001 0101 1100 1000 1000，效果是跨字节位域再次连通了。位域内存地址顺序，正好和原先相反。如果把大端机的内存视图画到一张纸上，相当于翻到纸的背面。</p> <p>此时，将这4个字节码流当作unsigned int，得到一个”无符号整形”，其”逻辑视图”等于大端机上的“内存视图”。左边恰好是结构体最开始的位域：0001 0001 0011 1010 1001 0110 0010 0000。因此我们将错就错，直接使用位操作符来左移相应的位数（需要计算后边所有位域的总比特数），即可得到对应的位域值。位移操作符等，都是对”逻辑视图”操作的。</p> <p>(4) 小端机传到大端机。网卡转换+ntohl转换后，依然在内存中得到一个位域顺序和正常顺序相反的”无符号整形”。只是这次使用位运算符要注意，第一个位域在”逻辑视图”的最右边，依次向左类推，和(3)的情形是相反的。</p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.sujing.info/2017/08/30/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F%E5%80%BC%E7%9A%84%E8%AF%BB%E5%8F%96Part2.html" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://www.sujing.info/2017/08/30/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F%E5%80%BC%E7%9A%84%E8%AF%BB%E5%8F%96Part2.html" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://www.sujing.info/2017/08/30/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%8D%E5%9F%9F%E5%80%BC%E7%9A%84%E8%AF%BB%E5%8F%96Part2.html" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://www.sujing.info/assets/js/jquery-1.12.0.min.js"></script> <script src="http://www.sujing.info/assets/js/jquery.dlmenu.min.js"></script> <script src="http://www.sujing.info/assets/js/jquery.goup.min.js"></script> <script src="http://www.sujing.info/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://www.sujing.info/assets/js/jquery.fitvid.min.js"></script> <script src="http://www.sujing.info/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'comt'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
